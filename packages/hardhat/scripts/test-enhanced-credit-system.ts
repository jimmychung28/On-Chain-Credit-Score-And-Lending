import { parseEther } from "viem";
import hre from "hardhat";

async function main() {
  console.log("üöÄ Testing Enhanced Credit Scoring System\n");

  const [deployer] = await hre.ethers.getSigners();
  const testUser = "0x010C5E560D0e042B53Cedba9A7404E90F82D7592";

  // Get contract instances
  const creditScoring = (await hre.ethers.getContract("CreditScoring", deployer)) as any;

  console.log("üìã Current Contract State:");
  console.log(`- CreditScoring: ${await creditScoring.getAddress()}`);
  console.log(`- Test User: ${testUser}\n`);

  try {
    // Add deployer as verified address for testing
    console.log("üîß Adding deployer as verified address...");
    await creditScoring.addVerifiedAddress(deployer.address);
    console.log("‚úÖ Deployer added as verified address\n");

    // Check if user is registered
    let isRegistered = false;
    try {
      const profile = await creditScoring.getCreditProfile(testUser);
      isRegistered = profile.isActive;
    } catch {
      console.log("‚ùå User not registered, registering now...");
    }

    // Register user if not already registered
    if (!isRegistered) {
      console.log("üîÑ Registering test user...");
      await creditScoring.createTestUser(testUser);
      console.log("‚úÖ User registered successfully\n");
    }

    // Demonstrate sophisticated transaction recording
    console.log("üí∞ Recording sophisticated transactions...");

    // Record various types of transactions
    const transactions = [
      {
        volume: parseEther("5.0"),
        gasUsed: 50000,
        counterparty: "0x1f9840a85d5af5bf1d1762f925bdaddc4201f984", // UNI token
        methodSignature: "0xa9059cbb", // transfer
        transactionType: 1, // DeFi
        description: "DeFi swap transaction",
      },
      {
        volume: parseEther("2.5"),
        gasUsed: 150000,
        counterparty: "0x7d2768dE32b0b80b7a3454c06BdAc94A69DDc7A9", // Aave
        methodSignature: "0xe8eda9df", // deposit
        transactionType: 1, // DeFi
        description: "Liquidity provision",
      },
      {
        volume: parseEther("0.1"),
        gasUsed: 80000,
        counterparty: "0x60f80121c31a0d46b5279700f9df786054aa5ee5", // NFT marketplace
        methodSignature: "0x23b872dd", // transferFrom
        transactionType: 2, // NFT
        description: "NFT purchase",
      },
    ];

    for (const tx of transactions) {
      console.log(`  üîÑ Recording ${tx.description}...`);
      await creditScoring.recordTransaction(
        testUser,
        tx.volume,
        tx.gasUsed,
        tx.counterparty,
        tx.methodSignature,
        tx.transactionType,
      );
    }
    console.log("‚úÖ Transactions recorded\n");

    // Record protocol interactions
    console.log("üèõÔ∏è Recording protocol interactions...");
    await creditScoring.recordProtocolInteraction(
      testUser,
      "0x1f9840a85d5af5bf1d1762f925bdaddc4201f984", // Uniswap
      parseEther("10.0"),
    );

    await creditScoring.recordProtocolInteraction(
      testUser,
      "0x7d2768dE32b0b80b7a3454c06BdAc94A69DDc7A9", // Aave
      parseEther("5.0"),
    );
    console.log("‚úÖ Protocol interactions recorded\n");

    // Record asset holdings
    console.log("üè¶ Recording asset holdings...");
    const assets = [
      { token: "0xa0b86a33e6441e0412b7b06b2e3ef51bf39c02a", amount: parseEther("1000"), isStablecoin: true }, // USDC
      { token: "0x1f9840a85d5af5bf1d1762f925bdaddc4201f984", amount: parseEther("50"), isStablecoin: false }, // UNI
      { token: "0x7fc66500c84a76ad7e9c93437bfc5ac33e2ddae9", amount: parseEther("10"), isStablecoin: false }, // AAVE
      { token: "0x514910771af9ca656af840dff83e8264ecf986ca", amount: parseEther("20"), isStablecoin: false }, // LINK
    ];

    for (const asset of assets) {
      console.log(`  üîÑ Recording holding: ${asset.isStablecoin ? "Stablecoin" : "Token"}...`);
      await creditScoring.recordAssetHolding(testUser, asset.token, asset.amount, asset.isStablecoin);
    }
    console.log("‚úÖ Asset holdings recorded\n");

    // Record DeFi activities
    console.log("üíé Recording DeFi activities...");
    await creditScoring.recordLiquidityProvision(testUser, parseEther("15.0"));
    await creditScoring.recordStakingRewards(testUser, parseEther("0.5"));
    console.log("‚úÖ DeFi activities recorded\n");

    // Record governance participation
    console.log("üó≥Ô∏è Recording governance participation...");
    for (let i = 0; i < 3; i++) {
      await creditScoring.recordGovernanceVote(testUser);
    }
    console.log("‚úÖ Governance votes recorded\n");

    // Add social attestations
    console.log("‚≠ê Adding social attestations...");
    const attestations = [
      { type: "0x677974636f696e5f6964656e74697479000000000000000000000000000000", score: 25 }, // gitcoin_identity
      { type: "0x74776974746572000000000000000000000000000000000000000000000000", score: 15 }, // twitter
      { type: "0x646973636f726400000000000000000000000000000000000000000000000000", score: 10 }, // discord
    ];

    for (const attestation of attestations) {
      console.log(`  üîÑ Adding attestation: ${attestation.type.slice(0, 20)}...`);
      await creditScoring.addAttestation(testUser, attestation.type, attestation.score);
    }
    console.log("‚úÖ Social attestations added\n");

    // Get and display enhanced profile
    console.log("üìä Enhanced Credit Profile Results:");
    console.log("=====================================");

    const profile = await creditScoring.getCreditProfile(testUser);
    const enhancedProfile = await creditScoring.getEnhancedProfile(testUser);
    const scoreBreakdown = await creditScoring.getScoreBreakdown(testUser);

    console.log(`\nüéØ Overall Credit Score: ${profile.score}`);
    console.log(`üìÖ Last Updated: ${new Date(Number(profile.lastUpdated) * 1000).toLocaleString()}\n`);

    console.log("üîç Score Breakdown:");
    console.log(`  ‚Ä¢ Transactional Behavior: ${scoreBreakdown[0]} (20% weight)`);
    console.log(`  ‚Ä¢ Behavioral Patterns: ${scoreBreakdown[1]} (15% weight)`);
    console.log(`  ‚Ä¢ Asset Management: ${scoreBreakdown[2]} (15% weight)`);
    console.log(`  ‚Ä¢ DeFi Participation: ${scoreBreakdown[3]} (20% weight)`);
    console.log(`  ‚Ä¢ Repayment History: ${scoreBreakdown[4]} (20% weight)`);
    console.log(`  ‚Ä¢ Governance Participation: ${scoreBreakdown[5]} (5% weight)`);
    console.log(`  ‚Ä¢ Social Reputation: ${scoreBreakdown[6]} (5% weight)\n`);

    console.log("üìà Enhanced Metrics:");
    console.log(`  ‚Ä¢ Total Gas Paid: ${enhancedProfile[0]} units`);
    console.log(`  ‚Ä¢ Unique Protocols: ${enhancedProfile[1]}`);
    console.log(`  ‚Ä¢ Stablecoin Ratio: ${enhancedProfile[2]}%`);
    console.log(`  ‚Ä¢ Asset Diversity: ${enhancedProfile[3]} tokens`);
    console.log(`  ‚Ä¢ Avg Holding Period: ${enhancedProfile[4]} blocks`);
    console.log(`  ‚Ä¢ Liquidity Provided: ${enhancedProfile[5]} wei`);
    console.log(`  ‚Ä¢ Staking Rewards: ${enhancedProfile[6]} wei`);
    console.log(`  ‚Ä¢ Governance Votes: ${enhancedProfile[7]}`);
    console.log(`  ‚Ä¢ NFT Interactions: ${enhancedProfile[8]}`);
    console.log(`  ‚Ä¢ Social Score: ${enhancedProfile[9]}\n`);

    console.log("üèÜ Credit Factors Analysis:");

    // Analyze transactional behavior
    const volumeInEth = Number(profile.totalVolume) / 1e18;
    console.log(`\nüí∞ Transactional Behavior (Score: ${scoreBreakdown[0]}):`);
    console.log(`  ‚Ä¢ Transaction Volume: ${volumeInEth.toFixed(2)} ETH`);
    console.log(`  ‚Ä¢ Transaction Count: ${profile.transactionCount}`);
    console.log(`  ‚Ä¢ Average Transaction: ${(volumeInEth / Number(profile.transactionCount)).toFixed(4)} ETH`);
    console.log(`  ‚Ä¢ Account Age: ${Number(profile.accountAge)} blocks`);

    // Analyze behavioral patterns
    const avgGas = Number(enhancedProfile[0]) / Number(profile.transactionCount);
    console.log(`\nüéØ Behavioral Patterns (Score: ${scoreBreakdown[1]}):`);
    console.log(`  ‚Ä¢ Average Gas Usage: ${avgGas.toFixed(0)} units`);
    console.log(`  ‚Ä¢ Protocol Diversity: ${enhancedProfile[1]} unique protocols`);
    console.log(`  ‚Ä¢ NFT Activity: ${enhancedProfile[8]} interactions`);

    // Analyze asset management
    console.log(`\nüè¶ Asset Management (Score: ${scoreBreakdown[2]}):`);
    console.log(`  ‚Ä¢ Portfolio Diversity: ${enhancedProfile[3]} different tokens`);
    console.log(`  ‚Ä¢ Stablecoin Allocation: ${enhancedProfile[2]}% of portfolio`);
    console.log(`  ‚Ä¢ Average Holding Period: ${enhancedProfile[4]} blocks`);

    // Analyze DeFi participation
    const liquidityEth = Number(enhancedProfile[5]) / 1e18;
    const stakingEth = Number(enhancedProfile[6]) / 1e18;
    console.log(`\nüíé DeFi Participation (Score: ${scoreBreakdown[3]}):`);
    console.log(`  ‚Ä¢ Liquidity Provided: ${liquidityEth.toFixed(4)} ETH`);
    console.log(`  ‚Ä¢ Staking Rewards Earned: ${stakingEth.toFixed(4)} ETH`);

    // Analyze repayment history
    const repaymentRate =
      (Number(profile.repaidLoans) / (Number(profile.repaidLoans) + Number(profile.defaultedLoans))) * 100;
    console.log(`\nüèÜ Repayment History (Score: ${scoreBreakdown[4]}):`);
    console.log(`  ‚Ä¢ Total Loans: ${Number(profile.loanCount)}`);
    console.log(`  ‚Ä¢ Successful Repayments: ${profile.repaidLoans}`);
    console.log(`  ‚Ä¢ Defaults: ${profile.defaultedLoans}`);
    console.log(`  ‚Ä¢ Success Rate: ${isNaN(repaymentRate) ? "N/A" : repaymentRate.toFixed(1)}%`);

    // Analyze governance participation
    console.log(`\nüó≥Ô∏è Governance Participation (Score: ${scoreBreakdown[5]}):`);
    console.log(`  ‚Ä¢ DAO Votes Cast: ${enhancedProfile[7]}`);
    console.log(`  ‚Ä¢ Governance Engagement: ${Number(enhancedProfile[7]) > 0 ? "Active" : "None"}`);

    // Analyze social reputation
    console.log(`\n‚≠ê Social Reputation (Score: ${scoreBreakdown[6]}):`);
    console.log(`  ‚Ä¢ Social Score Points: ${enhancedProfile[9]}`);
    console.log(`  ‚Ä¢ Verified Attestations: 3 types added`);
    console.log(`  ‚Ä¢ Community Standing: ${Number(enhancedProfile[9]) > 30 ? "High" : "Medium"}`);

    console.log("\nüéâ Enhanced Credit Scoring System Test Completed!");
    console.log("=====================================");
    console.log("üìä The system now evaluates creditworthiness based on:");
    console.log("  ‚úÖ Sophisticated transactional behavior patterns");
    console.log("  ‚úÖ Gas efficiency and protocol diversity");
    console.log("  ‚úÖ Asset portfolio management skills");
    console.log("  ‚úÖ Active DeFi ecosystem participation");
    console.log("  ‚úÖ Historical loan repayment performance");
    console.log("  ‚úÖ Governance and community engagement");
    console.log("  ‚úÖ Social attestations and reputation signals");
    console.log("\nüöÄ This provides a much more comprehensive and fair");
    console.log("   assessment of creditworthiness in the DeFi ecosystem!");
  } catch (error) {
    console.error("‚ùå Test failed:", error);
    throw error;
  }
}

main()
  .then(() => process.exit(0))
  .catch(error => {
    console.error(error);
    process.exit(1);
  });
